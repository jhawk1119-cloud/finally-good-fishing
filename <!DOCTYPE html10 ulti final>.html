<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ultimate Fishing: Long-Form Events</title>
    <style>
        :root { --p1: #4361ee; --p2: #f72585; --gold: #ffd700; --bg: #0b090a; --green: #52b788; --dark: #161a1d; --event: #ff0000; }
        body { background: var(--bg); color: #fff; font-family: 'Segoe UI', sans-serif; display: flex; flex-direction: column; align-items: center; margin: 0; padding: 20px; transition: background 1s; }
        
        .stats-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; width: 1250px; margin-bottom: 15px; }
        .stat-card { background: var(--dark); padding: 12px; border-radius: 12px; border: 1px solid #333; text-align: center; }

        canvas { background: #000; border: 4px solid #333; border-radius: 20px; }

        .main-container { display: flex; gap: 20px; width: 1350px; margin-top: 20px; height: 750px; }
        .scroll-panel { background: var(--dark); padding: 20px; border-radius: 15px; flex: 1; overflow-y: auto; border: 1px solid #333; }
        
        /* Event Banner with Timer */
        .event-banner { width: 100%; padding: 15px; background: var(--event); color: white; text-align: center; font-weight: bold; border-radius: 8px; margin-bottom: 10px; display: none; }
        .timer-text { font-family: monospace; font-size: 1.2rem; display: block; margin-top: 5px; }

        .item-row { background: #0b090a; padding: 10px; margin-bottom: 8px; border-radius: 8px; display: flex; justify-content: space-between; align-items: center; border: 1px solid #333; }
        .btn { padding: 6px 10px; cursor: pointer; border: none; border-radius: 5px; font-weight: bold; }
        .btn-buy { background: var(--p1); color: white; }
    </style>
</head>
<body>

    <div id="evt-banner" class="event-banner">
        <span id="evt-name">EVENT ACTIVE</span>
        <span id="evt-timer" class="timer-text">02:30</span>
    </div>

    <div class="stats-grid">
        <div class="stat-card">BANK<br><b id="m-val" style="color: var(--green);">$0</b></div>
        <div class="stat-card">WEATHER<br><b id="w-val" style="color: #4cc9f0;">Clear</b></div>
        <div class="stat-card">EVENT STATUS<br><b id="e-status" style="color: #aaa;">Idle</b></div>
        <div class="stat-card">ACTIVE ROD<br><b id="r-val" style="color: var(--p2);">...</b></div>
    </div>

    <div id="log">WAITING FOR CAST...</div>
    <canvas id="canvas" width="900" height="80"></canvas>

    <div class="main-container">
        <div class="scroll-panel">
            <h3>üè† Tank (Passive)</h3>
            <div id="tank-list"></div>
        </div>
        <div class="scroll-panel" style="flex: 1.5;">
            <h3>üé£ Shop (30 Rods)</h3>
            <div id="shop-box"></div>
        </div>
        <div class="scroll-panel" style="flex: 0.8;">
            <h3>üì¶ Vault</h3>
            <button class="btn" style="background:#660708; color:white; width:100%; margin-bottom:10px;" onclick="sellAll()">Sell All (0.75x Tax)</button>
            <div id="inv-box"></div>
        </div>
    </div>

<script>
/** 1. DATA **/
const rarityTiers = [
    { name: "Common", chance: 0.20, val: 10, native: "Clear", f: "üêü" },
    { name: "Neon", chance: 0.15, val: 150, native: "Storm", f: "üê†" },
    { name: "Magma", chance: 0.10, val: 1500, native: "Heatwave", f: "üî•" },
    { name: "Void", chance: 0.05, val: 75000, native: "Void", f: "üåë" },
    { name: "Glitch", chance: 0.01, val: 2e9, native: "Storm", f: "üëæ" },
    { name: "Universal", chance: 0.001, val: 5e15, native: "Clear", f: "üåç" }
];

const events = [
    { name: "VOID BREACH", target: "Void", multi: 8, dur: 150 }, // 2m 30s
    { name: "GOLD RUSH", target: "Common", multi: 50, dur: 150 },
    { name: "CYBER GLITCH", target: "Glitch", multi: 4, dur: 150 },
    { name: "SUPERNOVA", target: "Universal", multi: 1.5, dur: 150 }
];

const rods = Array.from({length: 30}, (_, i) => ({
    id: i, name: `Rod Mk ${i+1}`, cost: Math.pow(10, i) * 100, multi: Math.pow(5, i), speed: 4 + (i * 0.4)
}));

let p = { money: 0, inv: {}, owned: [0], active: 0, total: 0, tank: [] };
let weather = { name: "Clear", bonus: "Common", color: "#0b090a" };
let activeEvent = null;
let eventTimeLeft = 0;
let nextEventCooldown = 30; // Seconds until another event can even trigger

/** 2. EVENT TIMER LOGIC **/
function formatTime(seconds) {
    const mins = Math.floor(seconds / 60);
    const secs = seconds % 60;
    return `${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
}

setInterval(() => {
    // Handle Active Events
    if (activeEvent) {
        eventTimeLeft--;
        document.getElementById('evt-timer').innerText = formatTime(eventTimeLeft);
        if (eventTimeLeft <= 0) {
            activeEvent = null;
            nextEventCooldown = 60; // 1 minute break after long events
            document.getElementById('evt-banner').style.display = "none";
            document.getElementById('e-status').innerText = "Cooldown...";
        }
    } else {
        // Handle Cooldown and Random Triggers
        if (nextEventCooldown > 0) {
            nextEventCooldown--;
            document.getElementById('e-status').innerText = `Cooldown (${nextEventCooldown}s)`;
        } else {
            document.getElementById('e-status').innerText = "Ready";
            if (Math.random() < 0.01) { // 1% chance per second to trigger
                activeEvent = events[Math.floor(Math.random() * events.length)];
                eventTimeLeft = activeEvent.dur;
                document.getElementById('evt-banner').style.display = "block";
                document.getElementById('evt-name').innerText = activeEvent.name;
                document.getElementById('evt-timer').innerText = formatTime(eventTimeLeft);
            }
        }
    }
    updateUI();
}, 1000);

/** 3. CORE FUNCTIONS **/
function updateUI() {
    document.getElementById('m-val').innerText = "$" + Math.floor(p.money).toLocaleString();
    document.getElementById('w-val').innerText = weather.name;
    document.getElementById('r-val').innerText = rods[p.active].name;

    const sBox = document.getElementById('shop-box'); sBox.innerHTML = '';
    rods.forEach(r => {
        const has = p.owned.includes(r.id);
        sBox.innerHTML += `<div class="item-row"><span><b>${r.name}</b> (x${r.multi.toLocaleString()})</span>
        <button class="btn btn-buy" onclick="buyRod(${r.id})" ${(!has && p.money < r.cost)?'disabled':''}>${has?'EQUIP':'$'+r.cost.toLocaleString()}</button></div>`;
    });

    const iBox = document.getElementById('inv-box'); iBox.innerHTML = '';
    for(let k in p.inv) if(p.inv[k]>0) iBox.innerHTML += `<div class="item-row"><span>${k}</span><button class="btn btn-buy" onclick="toTank('${k}')">TANK</button></div>`;
}

function buyRod(id) {
    if(p.owned.includes(id)) p.active = id;
    else { p.money -= rods[id].cost; p.owned.push(id); p.active = id; }
    updateUI();
}

function sellAll() {
    let tot = 0;
    for(let k in p.inv) {
        let t = rarityTiers.find(x => x.f === k);
        if(t) tot += t.val * p.inv[k];
        p.inv[k] = 0;
    }
    p.money += tot * 0.75; updateUI();
}

function toTank(icon) {
    const t = rarityTiers.find(x => x.f === icon);
    p.inv[icon]--; p.tank.push({ icon: icon, payout: t.val * 0.1 }); // Simple tank logic
    updateUI();
}

/** 4. ENGINE **/
let gameState = "IDLE", barX = 100, barD = 1, tarX = 300, tarW = 80;
const cvs = document.getElementById('canvas'), ctx = cvs.getContext('2d');

function loop() {
    ctx.clearRect(0,0,900,100);
    if(gameState === "MINIGAME") {
        ctx.fillStyle = "#111"; ctx.fillRect(100, 30, 700, 20);
        ctx.fillStyle = (activeEvent) ? "var(--event)" : var(--p2); ctx.fillRect(tarX, 30, tarW, 20);
        let r = rods[p.active]; barX += r.speed * barD;
        if(barX > 790 || barX < 100) barD *= -1;
        ctx.fillStyle = "#fff"; ctx.fillRect(barX, 25, 8, 30);
    }
    requestAnimationFrame(loop);
}

window.addEventListener('keydown', (e) => {
    if(e.code === "Space") {
        e.preventDefault();
        if(gameState === "IDLE") {
            gameState = "WAITING";
            setTimeout(() => { if(gameState === "WAITING") { gameState = "MINIGAME"; tarX = 200+Math.random()*400; } }, 400);
        } else if(gameState === "MINIGAME") {
            if(barX >= tarX && barX <= tarX+tarW) {
                let sel = rarityTiers[Math.floor(Math.random() * rarityTiers.length)]; // Simplified for example
                let gain = sel.val * rods[p.active].multi;
                if(activeEvent && activeEvent.target === sel.name) gain *= activeEvent.multi;
                p.money += gain;
                p.inv[sel.f] = (p.inv[sel.f] || 0) + 1;
                document.getElementById('log').innerHTML = `<span style="color:var(--gold)">${sel.name}</span> CAUGHT (+$${gain.toLocaleString()})`;
            } else { document.getElementById('log').innerText = "MISSED"; }
            gameState = "IDLE"; updateUI();
        }
    }
});

loop();
</script>
</body>
</html>