<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Ultimate Fishing: Forge Edition</title>
    <style>
        body { 
            background: #87CEEB; font-family: sans-serif; 
            display: flex; flex-direction: column; align-items: center; padding: 20px; 
        }
        .stats { 
            background: white; padding: 15px; border-radius: 10px; 
            display: flex; gap: 20px; margin-bottom: 10px; width: 800px; justify-content: center;
        }
        canvas { background: #0077b6; border: 5px solid #f2d492; border-radius: 15px; }
        
        .layout { display: flex; gap: 20px; width: 850px; margin-top: 20px; height: 400px; }
        .panel { background: white; padding: 15px; border-radius: 10px; flex: 1; overflow-y: auto; }
        
        .item { 
            display: flex; justify-content: space-between; align-items: center; 
            padding: 8px; border-bottom: 1px solid #eee; font-size: 13px;
        }
        .btn { padding: 5px 10px; cursor: pointer; font-weight: bold; border-radius: 4px; border: none; }
        .buy-btn { background: #0077b6; color: white; }
        .forge-btn { background: #e67e22; color: white; }
        .sell-btn { background: #27ae60; color: white; width: 100%; margin-bottom: 10px; height: 30px; }
        
        #log { font-size: 20px; font-weight: bold; color: white; margin: 10px; text-shadow: 2px 2px #000; height: 30px; }
    </style>
</head>
<body>

    <div class="stats">
        <div>Cash: <b id="m-val">$0</b></div>
        <div>Rod: <b id="r-val">Wooden Rod</b></div>
        <div>Multi: <b id="x-val">1x</b></div>
    </div>

    <canvas id="canvas" width="800" height="150"></canvas>
    <div id="log">PRESS SPACE TO CAST</div>

    <div class="layout">
        <div class="panel">
            <h3>ðŸ›’ Shop & Forge</h3>
            <div id="shop-box"></div>
        </div>
        <div class="panel">
            <h3>ðŸ“¦ Inventory</h3>
            <button class="btn sell-btn" onclick="sellAll()">Sell All Fish</button>
            <div id="inv-box"></div>
        </div>
    </div>
    
    <button onclick="localStorage.clear(); location.reload();" style="margin-top:20px; opacity:0.5;">Emergency Reset Data</button>

<script>
/** * 1. CONFIG
 */
const rarities = [
    { name: "Minnow", chance: 0.35, val: 10, col: "#95a5a6" },
    { name: "Bass", chance: 0.20, val: 50, col: "#2ecc71" },
    { name: "Tuna", chance: 0.15, val: 300, col: "#3498db" },
    { name: "Electric Eel", chance: 0.10, val: 1500, col: "#f1c40f" },
    { name: "Golden Koi", chance: 0.08, val: 10000, col: "#ffd700" },
    { name: "Magma Ray", chance: 0.05, val: 50000, col: "#e74c3c" },
    { name: "Void Whale", chance: 0.04, val: 250000, col: "#8e44ad" },
    { name: "Reality Glitch", chance: 0.02, val: 2000000, col: "#ff4d4d" },
    { name: "Astral Divine", chance: 0.01, val: 100000000, col: "#ffffff" }
];

const allRods = [
    { id: 0, name: "Wooden Rod", cost: 0, multi: 1, speed: 4, type: 'shop' },
    { id: 1, name: "Steel Rod", cost: 1000, multi: 12, speed: 5, type: 'shop' },
    { id: 2, name: "Eel Caster", cost: 15000, multi: 80, speed: 6, type: 'forge', req: "Electric Eel", qty: 5 },
    { id: 3, name: "Golden Rod", cost: 200000, multi: 500, speed: 7, type: 'forge', req: "Golden Koi", qty: 10 },
    { id: 4, name: "Void Weaver", cost: 5000000, multi: 4000, speed: 8, type: 'forge', req: "Void Whale", qty: 5 },
    { id: 5, name: "Omnipotence", cost: 100000000, multi: 1000000, speed: 10, type: 'forge', req: "Astral Divine", qty: 1 }
];

let player = { money: 0, inv: {}, owned: [0], active: 0 };
let gState = "IDLE"; 
let barX = 100, barD = 1, tarX = 300, tarW = 100;

/** * 2. FUNCTIONS
 */
function updateUI() {
    const rod = allRods.find(r => r.id === player.active);
    document.getElementById('m-val').innerText = "$" + player.money.toLocaleString();
    document.getElementById('r-val').innerText = rod.name;
    document.getElementById('x-val').innerText = rod.multi.toLocaleString() + "x";

    // Update Shop/Forge
    const shopBox = document.getElementById('shop-box');
    shopBox.innerHTML = '';
    allRods.forEach(r => {
        const has = player.owned.includes(r.id);
        const isActive = player.active === r.id;
        let can = player.money >= r.cost;
        if (r.type === 'forge') can = can && (player.inv[r.req] || 0) >= r.qty;

        shopBox.innerHTML += `
            <div class="item">
                <div><b>${r.name}</b><br><small>${has ? 'Owned' : (r.type === 'forge' ? 'Req: '+r.qty+' '+r.req : '$'+r.cost.toLocaleString())}</small></div>
                <button class="btn ${r.type==='shop'?'buy-btn':'forge-btn'}" onclick="handleRod(${r.id})" ${(!has && !can) ? 'disabled' : ''}>
                    ${has ? (isActive ? 'Active' : 'Equip') : 'Get'}
                </button>
            </div>`;
    });

    // Update Inventory
    const invBox = document.getElementById('inv-box');
    invBox.innerHTML = '';
    for (let key in player.inv) {
        if (player.inv[key] > 0) invBox.innerHTML += `<div class="item">${key} <b>x${player.inv[key]}</b></div>`;
    }
}

function handleRod(id) {
    const r = allRods.find(x => x.id === id);
    if (player.owned.includes(id)) {
        player.active = id;
    } else {
        player.money -= r.cost;
        if (r.type === 'forge') player.inv[r.req] -= r.qty;
        player.owned.push(id);
        player.active = id;
    }
    save(); updateUI();
}

function sellAll() {
    for (let name in player.inv) {
        let count = player.inv[name];
        let data = rarities.find(f => f.name === name);
        if (data) player.money += (data.val * count);
        player.inv[name] = 0;
    }
    save(); updateUI();
}

function save() { localStorage.setItem('FishSaveFinal', JSON.stringify(player)); }
function load() {
    let s = localStorage.getItem('FishSaveFinal');
    if (s) player = JSON.parse(s);
    updateUI();
}

/** * 3. ENGINE
 */
const cvs = document.getElementById('canvas');
const ctx = cvs.getContext('2d');

function gameLoop() {
    ctx.clearRect(0, 0, cvs.width, cvs.height);
    if (gState === "MINIGAME") {
        ctx.fillStyle = "rgba(0,0,0,0.3)";
        ctx.fillRect(100, 60, 600, 30);
        ctx.fillStyle = "#ffd700";
        ctx.fillRect(tarX, 60, tarW, 30);
        
        let rod = allRods.find(r => r.id === player.active);
        barX += rod.speed * barD;
        if (barX > 690 || barX < 100) barD *= -1;
        
        ctx.fillStyle = "white";
        ctx.fillRect(barX, 50, 10, 50);
    }
    requestAnimationFrame(gameLoop);
}

window.addEventListener('keydown', (e) => {
    if (e.code === "Space") {
        e.preventDefault();
        if (gState === "IDLE") {
            gState = "WAITING";
            document.getElementById('log').innerText = "Waiting...";
            setTimeout(() => {
                if (gState !== "WAITING") return;
                gState = "MINIGAME";
                tarX = 150 + Math.random() * 400;
                document.getElementById('log').innerText = "STRIKE!";
            }, 1000 + Math.random() * 1000);
        } else if (gState === "MINIGAME") {
            if (barX >= tarX && barX <= tarX + tarW) {
                let roll = Math.random(), cum = 0, fish = rarities[0];
                for (let r of rarities) {
                    cum += r.chance;
                    if (roll < cum) { fish = r; break; }
                }
                let rod = allRods.find(r => r.id === player.active);
                let win = fish.val * rod.multi;
                player.money += win;
                player.inv[fish.name] = (player.inv[fish.name] || 0) + 1;
                document.getElementById('log').innerHTML = `<span style="color:${fish.col}">${fish.name}</span> caught! +$${win.toLocaleString()}`;
            } else {
                document.getElementById('log').innerText = "Missed!";
            }
            gState = "IDLE";
            save(); updateUI();
        }
    }
});

load(); gameLoop();
</script>
</body>
</html>